- name: Deploy to EC2
  env:
    MONGO_URI: ${{ secrets.MONGO_URI_PROD }}
    JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
    APP_DOMAIN: ${{ secrets.APP_DOMAIN }}
  run: |
    ssh -tt -o ServerAliveInterval=60 -o ServerAliveCountMax=100 -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << EOF
      set -e
      echo "✅ Connected to EC2"

      # Keep GitHub session alive
      (while true; do echo "💓 KeepAlive - \$(date)"; sleep 60; done) &
      KEEPALIVE_PID=\$!
      trap "kill \$KEEPALIVE_PID" EXIT

      echo "🔁 Cloning or pulling latest code..."
      if [ ! -d "taskmate" ]; then
        git clone https://github.com/aalok-infobeans/taskmate.git
      fi

      cd taskmate
      git pull origin main

      echo "🧹 Stopping old containers..."
      docker compose down || true

      echo "🚀 Starting containers..."
      MONGO_URI="$MONGO_URI" \
      PORT="3000" \
      NODE_ENV="production" \
      JWT_SECRET_KEY="$JWT_SECRET_KEY" \
      APP_DOMAIN="$APP_DOMAIN" \
      docker compose up --build -d

      echo "✅ Deployment completed successfully"

      # ✅ Properly stop the keepalive loop
      kill \$KEEPALIVE_PID
      wait \$KEEPALIVE_PID 2>/dev/null || true
    EOF
